<{assign var='tpl_title' value=L("我要入驻")}>
<{include file="block/header.html"}>
<div class="page page-current">
    <!--头部-->
    <header class="bar bar-nav"><a class="button button-link button-nav pull-left back"> <span
            class="iconfont icon-iconfontxiangyou"></span> </a>
        <h1 class="title">我要入驻</h1>
    </header>
    <!--头部结束-->
    <div class="content">
        <div class="mar10">
            <div class="mineEnter_form">
                <div class="list-block">
                    <ul>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">申请人</div>
                                    <div class="item-input">
                                        <input type="text" id="contact" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">联系电话</div>
                                    <div class="item-input">
                                        <input type="text" id="mobile" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">验证码</div>
                                    <div class="item-input">
                                        <input type="text" id="yzm" placeholder="">
                                    </div>
                                    <a href="javascript:;" class="yzmget">获取验证码</a>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">密码</div>
                                    <div class="item-input">
                                        <input type="password" id="passwd" placeholder="请设置密码（6-20位字符）">
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mineEnter_form">
                <div class="list-block">
                    <ul>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">店铺名称</div>
                                    <div class="item-input">
                                        <input type="text" id="title" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">服务电话</div>
                                    <div class="item-input">
                                        <input type="text" id="phone" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label">店铺类型</div>
                                    <div class="item-input">
                                        <input type="text" id="cate" class='cate-picker' placeholder="">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="item-content item-link" id="shop_reg_select_addr">
                                <div class="item-inner">
                                    <div class="item-title label">店铺地址</div>
                                    <div class="item-input" id="add-box">
                                        <i class="dizhi-select"></i>
                                        <input type="text" placeholder="点击选择" id="shop_addr">
                                    </div>
                                </div>
                            </div>
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-title label2">楼号-门牌号</div>
                                    <div class="item-input">
                                        <input type="text" placeholder="例：16号楼406室" id="shop_house">
                                    </div>
                                </div>
                            </div>
                        </li>
                        <input type="hidden" id="shop_lng" value="">
                        <input type="hidden" id="shop_lat" value="">
                    </ul>
                </div>
            </div>
            <div class="mineEnter_form">
                <div class="list-block">
                    <ul>
                        <li class="align-top">
                            <div class="item-content">
                                <div class="item-inner">
                                    <div class="item-input">
                                        <textarea placeholder="店铺简介" id="info"></textarea>
                                        <p class="txt_right black9">
                                            <small>200字以内</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="content-block"><a class="button button-big button-fill button-success" id="subbtn">提交</a></div>
            <script>
                $(document).off('click', '#subbtn').on('click', '#subbtn', function () {
                    var contact = $('#mobile').val();
                    var mobile = $('#mobile').val();
                    var yzm = $('#yzm').val();
                    var passwd = $('#passwd').val();
                    var title = $('#title').val();
                    var phone = $('#phone').val();
                    var addr = $('#shop_addr').val();
                    var info = $('#info').val();
                    var cate = $('#cate').val();
                    var lng = $('#shop_lng').val();
                    var lat = $('#shop_lat').val();
                    $.post("<{link ctl='ucenter/shop:register'}>", {
                        contact: contact,
                        mobile: mobile,
                        yzm: yzm,
                        passwd: passwd,
                        title: title,
                        phone: phone,
                        addr: addr,
                        cate: cate,
                        info: info,
                        lng: lng,
                        lat: lat
                    }, function (ret) {
                        if (ret.error == 0) {
                            localStorage.removeItem('shop_reg_adderss');
                            $.alert(ret.message);
                            setTimeout(function () {
                                $.closeModal();
                                window.location.href = "<{link ctl='ucenter/index'}>";
                            }, 2000)
                        } else {
                            $.alert(ret.message);
                        }

                    }, 'json');

                });
            </script>
        </div>
    </div>
    <!--内容结束-->
</div>

<script>
    $(function () {
        //red store customer input after select map
        if (localStorage['arr_address']) {
            arr_address = JSON.parse(localStorage['arr_address']);
            var contact = $('#contact').val(arr_address['contact']);
            var mobile = $('#mobile').val(arr_address['mobile']);
            var yzm = $('#yzm').val(arr_address['yzm']);
            var passwd = $('#passwd').val(arr_address['passwd']);
            var title = $('#title').val(arr_address['title']);
            var phone = $('#phone').val(arr_address['phone']);
            var info = $('#info').val(arr_address['info']);
            var cate = $('#cate').val(arr_address['cate']);
        }

        if (localStorage['shop_reg_adderss']) {
            var addrJSON = JSON.parse(localStorage['shop_reg_adderss']);
            if (addrJSON.addr) {
                $('#shop_addr').val(addrJSON.addr);
            }
            if (addrJSON.house) {
                $('#shop_house').val(addrJSON.house);
            }
            if (addrJSON.lng) {
                $('#shop_lng').val(addrJSON.lng);
            }
            if (addrJSON.lat) {
                $('#shop_lat').val(addrJSON.lat);
            }
        }

        var mobile_timeout;
        var mobile_count = 60;
        var mobile_lock = 0;


        $(".yzmget").click(function () {
            var mobile = $("#mobile").val();
            if (mobile) {
                if (mobile_lock == 0) {
                    mobile_count = 60;
                    $(".yzmget1").addClass("graybg");
                    $('.yzmget1').attr("disabled", "disabled");
                    verify_pic();
                }
            } else {
                $.alert("请填写手机号");
            }
        });

        BtnCount = function () {
            if (mobile_count == 0) {
                $(".yzmget").removeClass("graybg");
                $('.yzmget').removeAttr("disabled");
                $('.yzmget').text("重新获取");
                mobile_lock = 0;
                clearTimeout(mobile_timeout);
                $('.yzmget').removeClass("on");
            }
            else {
                mobile_count--;
                $('.yzmget').text(+mobile_count.toString() + "s重新获取");
                mobile_timeout = setTimeout(BtnCount, 1000);
                $('.yzmget').addClass("on");
            }
        };
        //注册页获取验证码部分结束
        function verify_pic() {
            var modal = $.modal({
                title: "<div class='txt_left'>请填写图形验证码</div>",
                afterText: "<div class='yzmint'><input type='text' id='pass-verify' value=''><span class='yzmimg'><img verify='#pass-verify' src=" + "<{link ctl='magic:verify' http='ajax'}>&_=<{$pager.dateline}>" + " id='pass-verify'/></span></div>",
                buttons: [
                    {
                        text: '取消'
                    },
                    {
                        text: '确定',
                        bold: true,
                        onClick: function () {
                            var verifycode = $("#pass-verify").val();
                            var link = "<{link ctl='passport/verify_img'}>";
                            $.post(link, {verifycode: verifycode}, function (ret) {
                                if (ret.error) {
                                    $.alert(ret.message);
                                } else {
                                    send_sms();
                                }
                            }, 'json');
                        }
                    },
                ]
            })
            $.swiper($$(modal).find('.swiper-container'), {pagination: '.swiper-pagination'});
        }

        function send_sms() {
            var mobile = $('#mobile').val();
            var link = "<{link ctl='passport/sendsms'}>";
            $.post(link, {mobile: mobile}, function (ret) {
                if (ret.error == 0) {
                    BtnCount();
                    mobile_lock = 1;
                    $(".get_yzm").addClass("on");
                    $('.get_yzm').attr("disabled", "disabled");
                } else {
                    $.alert(ret.message);
                    mobile_lock = 0;
                }
            }, 'json');
        }
    });

    //cate pick 方法
    $.ajax({
        url: '<{link ctl="ucenter/shop:index"}>',
        type: 'POST',
        data: {cate: 1},
        datatype: "json",
        error: function () {
            alert('error');
        },
        success: function (data) {
            var d = '';
            data = JSON.parse(data);
            for (var i = 0 in data) {
                d += '{"name":"' + data[i].title + '","sub":[';
                if (data[i].children) {
                    var cc = data[i].children;
                    for (var j = 0 in cc) {
                        d += '{"name":"' + cc[j].title + '"},';
                    }
                }
                d += '],"type":0},';
            }
            d = eval('[' + d + ']');
            $.smConfig.rawCitiesData = d;
            real();
            $(".cate-picker").catePicker({
                toolbarTemplate: '<header class="bar bar-nav">\
    		  		<button class="button button-link pull-right close-picker">确定</button>\
    		  		<button class="button button-link pull-left close-picker">取消</button>\
    		  		</header>',
            });
        }
    });

    function real() {
        "use strict";
        var format = function (data) {
            var result = [];
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                if (d.name === "请选择") continue;
                result.push(d.name);
            }
            if (result.length) return result;
            return [""];
        };

        var sub = function (data) {
            if (!data.sub) return [""];
            return format(data.sub);
        };

        var getCities = function (d) {
            for (var i = 0; i < raw.length; i++) {
                if (raw[i].name === d) return sub(raw[i]);
            }
            return [""];
        };

        var getDistricts = function (p, c) {
            for (var i = 0; i < raw.length; i++) {
                if (raw[i].name === p) {
                    for (var j = 0; j < raw[i].sub.length; j++) {
                        if (raw[i].sub[j].name === c) {
                            return sub(raw[i].sub[j]);
                        }
                    }
                }
            }
            return [""];
        };

        var raw = $.smConfig.rawCitiesData;
        var provinces = raw.map(function (d) {
            return d.name;
        });
        var initCities = sub(raw[0]);
        var initDistricts = [""];

        var currentProvince = provinces[0];
        var currentCity = initCities[0];
        var currentDistrict = initDistricts[0];

        var t;
        var defaults = {

            cssClass: "city-picker",
            rotateEffect: false,  //为了性能

            onChange: function (picker, values, displayValues) {
                var newProvince = picker.cols[0].value;
                var newCity;
                if (newProvince !== currentProvince) {
                    // 如果Province变化，节流以提高reRender性能
                    clearTimeout(t);

                    t = setTimeout(function () {
                        var newCities = getCities(newProvince);
                        newCity = newCities[0];
                        var newDistricts = getDistricts(newProvince, newCity);
                        picker.cols[1].replaceValues(newCities);
                        currentProvince = newProvince;
                        currentCity = newCity;
                        picker.updateValue();
                    }, 200);
                    return;
                }
                newCity = picker.cols[1].value;
                if (newCity !== currentCity) {
                    currentCity = newCity;
                    picker.updateValue();
                }
            },

            cols: [
                {
                    textAlign: 'center',
                    values: provinces,
                    cssClass: "col-province"
                },
                {
                    textAlign: 'center',
                    values: initCities,
                    cssClass: "col-city"
                },
            ]
        };

        $.fn.catePicker = function (params) {
            return this.each(function () {
                if (!this) return;
                var p = $.extend(defaults, params);
                //计算value
                if (p.value) {
                    $(this).val(p.value.join(' '));
                } else {
                    var val = $(this).val();
                    val && (p.value = val.split(' '));
                }

                if (p.value) {
                    //p.value = val.split(" ");
                    if (p.value[0]) {
                        currentProvince = p.value[0];
                        p.cols[1].values = getCities(p.value[0]);
                    }
                    if (p.value[1]) {
                        currentCity = p.value[1];
                        p.cols[2].values = getDistricts(p.value[0], p.value[1]);
                    } else {
                        p.cols[2].values = getDistricts(p.value[0], p.cols[1].values[0]);
                    }
                    !p.value[2] && (p.value[2] = '');
                    currentDistrict = p.value[2];
                }
                $(this).picker(p);
            });
        };
    }
    ;

    $(document).off('click', '#shop_reg_select_addr').on('click', '#shop_reg_select_addr', function () {
        //store user input data
        var contact = $('#contact').val();
        var mobile = $('#mobile').val();
        var yzm = $('#yzm').val();
        var passwd = $('#passwd').val();
        var title = $('#title').val();
        var phone = $('#phone').val();
        var info = $('#info').val();
        var cate = $('#cate').val();
        var arr_address = {
            "contact": contact,
            "mobile": mobile,
            "yzm": yzm,
            "passwd": passwd,
            "passwd": passwd,
            "title": title,
            "phone": phone,
            "info": info,
            "cate": cate,
        };
        localStorage['arr_address'] = JSON.stringify(arr_address);
        $.router.load("<{link ctl='ucenter/shop:map'}>");
    })
</script>
<{include file="block/footer.html"}>