<{assign var='tpl_title' value=L("领取优惠券")}>
<{include file="block/header.html" }>
    <div class="page page-current">
    	<!--头部-->
        <header class="bar bar-nav"> 
        	<a class="button button-link button-nav pull-left back"> 
        		<span class="iconfont icon-iconfontxiangyou"></span> 
        	</a>
            <h1 class="title">领取优惠券</h1>
        </header>
        <!--头部结束-->
        <div class="content">
           <div class="mineCoupon_list_box">
			<{foreach $items as $k=>$item}>
				<div class="mineCoupon_list">
                	<div class="left">
                    	<h3 class="overflow_clear"><img src="<{$pager.img}>/<{$item.logo}>"><{$item.shop_name}></h3>
                        <ul>
                            <li>满<{$item.order_amount}>元可用</li>
                            <li><{$item.stime}>至<{$item.ltime}></li>
                        </ul>
                    </div>
                    <div class="right">
                    	<div class="price <{if in_array($item.coupon_id,$arr_user_coupon)}>black9<{else}>fontcl1 <{/if}>"><small>￥</small><{$item.coupon_amount}></div>
                        <{if in_array($item.coupon_id,$arr_user_coupon)}>
                        <p class=" black9" >已领取</p>
                        <{else}>
                        <p class="state maincl" cid="<{$item.coupon_id}>" shop_id="<{$item.shop_id}>">立即领取</p>
                        <{/if}>
                    </div>
                </div>
			<{/foreach}>           
           </div>
        </div>        
    <!--内容结束-->   
    </div>
    <script type="text/javascript">

	// 立即领取
	$(document).off('click','.state').on('click','.state',function() {
	    var shop_id = $(this).attr('shop_id');
	    var cid = $(this).attr('cid');
	    $.ajax({  
	        url: "<{link ctl='shop:getcoupon'}>", 
	        async: true,  
	        dataType: 'json',  
	        data: {"shop_id":shop_id,"coupon_id":cid},
	        type: 'POST',   
	        success: function (ret) { 
                $.alert(ret.message, function () {
                    window.location.reload();
                });
                if(ret.error != 0) {
	                setTimeout(function(){
	                    $('.modal').remove();
	                    $('.modal-overlay').remove();
	                },4000);
	            }else {
	                setTimeout(function(){
	                    window.location.reload();
	                },4000);
	            }
	        }, 
	        error: function (xhr, status, err) { 
	            $.alert(err); 
	        },  
	    });
	})
	</script>
<{include file="block/footer.html"}>