<{assign var='tpl_title' value=L("编辑地址")}>
<{include file="weidian/$theme_style/block/header.html"}>
<div class="page page-current">
    <!--头部-->
    <header class="bar bar-nav header_Ico">
        <a class="button button-link button-nav pull-left external" href="<{link ctl='weidian/ucenter/addr:items'}>">
            <span class="Ico1"></span>
        </a>
        <a class="button button-link button-nav pull-right" id="edit_save">保存</a>
        <h1 class="title">编辑地址</h1>
    </header>
    <!--头部结束-->
    <div class="content">
        <div class="dizhi-add-box mt10">
            <div class="list-block border_b border_t">
                <ul>
                    <li>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title label">联系人</div>
                                <div class="item-input">
                                    <input type="text" placeholder="您的姓名" value="<{$detail.contact}>" id="contact"></div>
                            </div> <i class="cha-icon"></i>
                        </div>
                    </li>
                    <li>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title label">手机号</div>
                                <div class="item-input">
                                    <input type="text" placeholder="配送员联系您的电话" value="<{$detail.mobile}>" id="mobile"></div>
                            </div> <i class="cha-icon"></i>
                        </div>
                    </li>
                    <li>
                        <div class="item-content item-link" id="goto_map">
                            <div class="item-inner">
                                <div class="item-title label">收货地址</div>
                                <div class="item-input">
                                    <i class='dizhi-choose'></i>
                                    <input type="text" placeholder="请选择小区、大厦或学校" style="display:inline-block;width:90%" value="<{$detail.addr}>" id="addr"></div>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title label">门牌号</div>
                                <div class="item-input">
                                    <input type="text" placeholder="请输入门牌号等详细信息" value="<{$detail.house}>" id="house"></div>
                            </div>
                            <i class="cha-icon"></i>
                        </div>
                    </li>
                    <input type="hidden" id="lng" value="<{$detail.lng}>">
                    <input type="hidden" id="lat" value="<{$detail.lat}>">
                    <li>
                        <div class="item-content">
                          <div class="item-inner open-vertical-modal">
                            <div class="item-title label">标签</div>
                            <div class="item-input txt_left">
                                <div class="biaoqian 
                                <{if $detail.tag==1}>bg1
                                <{else if $detail.tag==2}>bg2
                                <{else if $detail.tag==3}>bg3
                                <{else if $detail.tag==4}>nobg
                                <{else}>
                                <{/if}>
                                ">
                                <{if $detail.tag==1}>公司
                                <{else if $detail.tag==2}>家
                                <{else if $detail.tag==3}>学校
                                <{else if $detail.tag==4}>其他
                                <{else}>
                                <{/if}>
                                <input type="hidden" id="tag" value="<{$detail.tag}>"></div>
                                
                            </div>
                          </div>
                          <i class="xia-icon"></i>
                        </div>
                      </li>
                </ul>
            </div>
            <div class="long_btn mt10">
                <a href="javascript:addr_delete();">删除地址</a>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

$(document).off('click','.open-vertical-modal').on('click','.open-vertical-modal',function(){
    $.modal({
      title:  "<div class='txt_left maincl'>选择地址标签</div>",
      verticalButtons: true,
      buttons: [
        {
          text: "<div class='bgcolor_white'>无</div>",
          onClick: function() {
              $('.open-vertical-modal .item-input').html("<div class='biaoqian nobg' tag_name='无'>无<input type='hidden' id='tag' value='0'></div>");
          }
        },
        {
          text: "<div class='bgcolor_white'>家</div>",
          onClick: function() {
              $('.open-vertical-modal .item-input').html("<div class='biaoqian bg2' tag_name='家'>家<input type='hidden' id='tag' value='2'></div>");
          }
        },
        {
          text: "<div class='bgcolor_white'>公司</div>",
          onClick: function() {
              $('.open-vertical-modal .item-input').html("<div class='biaoqian bg1' tag_name='公司'>公司<input type='hidden' id='tag' value='1'></div>");
          }
        },
        {
          text: "<div class='bgcolor_white'>学校</div>",
          onClick: function() {
              $('.open-vertical-modal .item-input').html("<div class='biaoqian bg3' tag_name='学校'>学校<input type='hidden' id='tag' value='3'></div>");
          }
        },
      ]
    })
});

//删除地址
function addr_delete() {
    var addr_id = parseInt(<{$detail.addr_id}>);
    $.confirm('确定要删除该地址吗?', '温馨提示',function () {
            // 点击确认按钮事件
            $.ajax({  
                url: "<{link ctl='weidian/ucenter/addr:delete'}>",
                async: true,  
                dataType: 'json',  
                type: 'POST',  
                data:{"addr_id":addr_id}, 
                success: function (ret) { 
                    if(ret.error > 0){
                        $.alert(ret.message);
                        setTimeout(function(){$.closeModal();},4000);
                    }else{
                        $.alert(ret.message);
                        setTimeout(function(){
                            window.location.href = "<{link ctl='weidian/ucenter/addr:items'}>";
                        },1500);
                    }
                }, 
                error: function (XMLHttpRequest, textStatus, errorThrown) { 
                    alert(errorThrown); 
                },     
            });
        },function () {
            // 点击取消按钮事件
        }
    );
}

// 保存修改
$(document).off('click','#edit_save').on('click','#edit_save',function(){
    var addr_id = parseInt(<{$detail.addr_id}>);
    var contact = $('#contact').val();
    var mobile = $('#mobile').val();
    var addr = $('#addr').val();
    var house = $('#house').val();
    var addr_lng = $('#lng').val();
    var addr_lat = $('#lat').val();
    var tag = $('#tag').val();
    if(contact == '') {
        $.alert('请填写联系人');
        setTimeout(function(){$.closeModal();},4000);
        return;
    }
    if(mobile == '') {
        $.alert('请填写手机号');
        setTimeout(function(){$.closeModal();},4000);
        return;
    }
    if(house == '') {
        $.alert('收货地址不能为空');
        setTimeout(function(){$.closeModal();},4000);
        return;
    }
    if(addr_lng == '' || addr_lat == '') {
        $.alert('经纬度坐标有误');
        setTimeout(function(){$.closeModal();},4000);
        return;
    }
    $.ajax({  
        url: "<{link ctl='weidian/ucenter/addr:edit_save'}>",
        async: true,  
        dataType: 'json',  
        type: 'POST',  
        data:{"addr_id":addr_id,"contact":contact,"mobile":mobile,"addr":addr,"house":house,"addr_lng":addr_lng,"addr_lat":addr_lat,"tag":tag}, 
        success: function (ret) { 
            if(ret.error > 0){
                $.alert(ret.message);
                setTimeout(function(){$.closeModal();},4000);
            }else{
                $.alert(ret.message);
                localStorage.removeItem('weidian_choose_addr');
                localStorage.removeItem('weidian_choosed_addr');
                setTimeout(function(){
                    window.location.href = "<{link ctl='weidian/ucenter/addr:items'}>";
                },1500);
            }
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(errorThrown); 
        },     
    });
})

$(document).off('click','#goto_map').on('click','#goto_map',function(){
    localStorage['weidian_choose_addr'] = JSON.stringify({"backurl":window.location.href,"contact":$('#contact').val(),"mobile":$('#mobile').val(),"house":$('#house').val(),"tag":$('#tag').val()});
    localStorage['weidian_addr_map_backurl'] = window.location.href;
    $.router.load("<{link ctl='weidian/ucenter/addr:map'}>");
})

if(localStorage['weidian_choosed_addr']) {
    var vJSON = JSON.parse(localStorage['weidian_choosed_addr']);
    if(vJSON.address) {
        $('#addr').val(vJSON.address);
    }
    if(vJSON.lng && vJSON.lat) {
        $('#lng').val(vJSON.lng);
        $('#lat').val(vJSON.lat);
    }
    if(vJSON.contact) {
        $('#contact').val(vJSON.contact);
    }
    if(vJSON.mobile) {
        $('#mobile').val(vJSON.mobile);
    }
    if(vJSON.house) {
        $('#house').val(vJSON.house);
    }
}

$(document).off('click','.cha-icon').on('click','.cha-icon',function(){
    $(this).parent().find('input').val("");
})
</script>
<{include file="weidian/$theme_style/block/footer.html"}>