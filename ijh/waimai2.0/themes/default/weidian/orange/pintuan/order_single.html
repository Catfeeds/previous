<{assign var='tpl_title' value=L("我要开团")}>
<{include file="weidian/<{$theme_style}>/block/header.html"}>

<div class="page page-current">
    <!--头部-->
    <header class="bar bar-nav header_Ico"> <a class="button button-link button-nav pull-left back"> <span class="Ico1"></span> </a>
        <h1 class="title">我要开团</h1>
    </header>
    <!--头部结束-->
<!--     <nav class="bar bar-tab jion_soon">
        <span class="box1 color1 heji" id="total_price">合计：<small>￥</small><{$data.money_total}></span>
        <a href="javascript:order_create();" class="pub_btn">立即购买</a>
        <form id="single_pintuan">
            <{$html_hidden_input}>
        </form>
    </nav> -->
    <nav class="bar bar-tab kaituan-footer txt_center">
        <div class="box1 color1" id="total_price">合计：<small>￥</small><{$data.money_total}></div>
        <div class="box2 f_size1"><a href="javascript:order_create();" class="pub_btn">立即购买</a></div>
        <form id="single_pintuan">
            <{$html_hidden_input}>
        </form>
    </nav>
    <div class="content">
        <div class="wantJoin-tuan">
            <div class="list-block">
                <ul>
                    <{if $shop.is_ziti==1}>
                    <li class="item-content selfti_kaiguan" style="padding-left:0;">
                        <div class="item-inner" style="margin-left:0;">
                            <div class="item-title"><span class="choose"><span style="padding-left:0.75rem">是否自提</span></span>
                            </div>
                            <div class="item-input">
                                <label class="label-switch">
                                    <input type="checkbox">

                                    <div class="checkbox"></div>
                                </label>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-link danhao border_b" id="ziti_addr">
                        <div class="item-inner">
                            <div class="item-title"><span style="padding-left:0.75rem;">自提地址</span></div>
                            <div class="item-after ziti-input">
                                <div style="display:inline-block;">
                                    <input type="text" placeholder="<{mb_substr($shop.addr,0,15,"utf-8")}>">
                                </div>
                            </div>
                        </div>
                    </li>
                    <{/if}>
                </ul>
            </div>
            <{if !$m_addr}>
            <div class="list-block media-list peisong" style="margin-bottom:0;">
                <ul>
                    <li>
                        <a href="<{link ctl='ucenter/addr/create'}>" class="item-link item-content" id="create_addr">
                            <div class="item-media"><i class="iconfont icon-site-copy jiaodan"></i></div>
                            <div class="item-inner">
                                <div class="item-subtitle"><span>您还没有设置地址</span></div>
                                <div class="item-subtitle"><span>点击立即添加地址</span></div>
                            </div>
                        </a>
                    </li>

                </ul>
            </div>
            <{else}>
            <div class="list-block media-list peisong" style="margin-bottom:0;">
                <ul>
                    <li>
                        <a href="#" id="select_addr" class="item-link item-content">
                            <div class="item-media"><i class="iconfont icon-site-copy jiaodan"></i></div>
                            <div class="item-inner">
                                <div class="item-subtitle"><span id="contact"><{$m_addr.contact}></span><span style="margin-left:0.5rem" id="mobile"><{$m_addr.mobile}></span></div>
                                <div class="item-text"><span class="black3" id="address"><{$m_addr.addr}><{$m_addr.house}></span></div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
            <{/if}>


            <div class="mt10"></div>

            <div class="dingdan-details mb10">
                <div class="list-block media-list">
                    <ul>
                        <li> <a href="#" class="item-content">
                            <div class="item-media"><img src="/attachs/<{$product.photo}>" style='width: 4.2rem;'></div>
                            <div class="item-inner">
                                <div class="item-title black3"><big>【<{$data.product_title}>】</big></div>
                                <div class="item-text"><{$product.intro}></div>
                                <div class="item-title-row">
                                    <div class="item-title"><span class="mr10">单人购买</span><big class=" fontcl1">￥<{$data.product_price}></big><small class="fontcl1">/份</small></div>
                                    <div class="item-after" style=" color:#ff7800;">X <big><{$data.product_num}></big></div>
                                </div>
                            </div>
                        </a> </li>
                    </ul>
                </div>
            </div>



            <div class="mt10"></div>
            <div class="list-block">
                <ul>
                    <li class="item-content">
                        <div class="item-inner">
                            <div class="item-title f_size1" style=" color:#767679;">商品总额</div>
                            <div class="item-after f_size1" style=" color:#ff7800;">￥<{$data.product_money}></div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="mt10"></div>

            <div class="list-block">
                <ul>
                    <li class="item-content">
                        <div class="item-inner">
                            <div class="item-title f_size1" style=" color:#767679;">运费</div>
                            <div class="item-after f_size1" style=" color:#ff7800;">￥<{$data.ship_fee}></div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="mt10"></div>


        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function(){
        $('#ziti_addr').hide();
        // 自动填写选择的地址
        if(localStorage['select_address']) {
            var addr = JSON.parse(localStorage['select_address']);
            if(addr.addr_id && addr.contact && addr.mobile && addr.address) {
                $("input[name='params[addr_id]']").val(addr.addr_id);
                $("#contact").html(addr.contact);
                $('#mobile').html(addr.mobile);
                $("#address").html(addr.address);
            }
        }

        // 读取是否自提
        if(localStorage['pintuan_order_single_state']) {
            var stateJSON = JSON.parse(localStorage['pintuan_order_single_state']);
            if(stateJSON.pei_type == 3) {
                $('.selfti_kaiguan').find('input').click();
                $("input[name='params[pei_type]']").val(3);
                $('#ziti_addr').css('display','flex');
            }else {
                $('.selfti_kaiguan').find(':checked').click();
                $("input[name='params[pei_type]']").val(<{$shop.pei_type}>);
            }
            if(stateJSON.addr_id) {
                $("input[name='params[addr_id]']").val(status.addr_id);
            }
        }
    })

    // 自提地址商家位置
    $(document).off('click','#ziti_addr').on('click','#ziti_addr',function() {
        localStorage['pintuan_order_single_state'] = JSON.stringify({"pei_type":3});
        var shop_id = parseInt(<{$shop.shop_id}>);
        $.router.load("<{link ctl='pintuan:locate-"+shop_id+"'}>");
    })
    $(document).off('click','.selfti_kaiguan .label-switch').on('click','.selfti_kaiguan .label-switch',function() {
        localStorage.removeItem('pintuan_order_single_state');
        if($(this).hasClass('active')) {
            // 配送
            $(this).removeClass('active');
            $('#ziti_addr').hide();
            $('#ship_fee').show();
            $('#total_price').html('合计：<small>￥</small>'+<{$data.money_total}>);
            $("input[name='params[pei_type]']").val(<{$shop.pei_type}>);
            $('.peisong').show();
        }else {
            // 自提
            $(this).addClass('active');
            $('#ziti_addr').show();
            $('#ship_fee').hide();
            $('#total_price').html('合计：<small>￥</small>'+<{$data.product_money}>);
            $("input[name='params[pei_type]']").val(3);
            $('.peisong').hide();
        }
    })

    // 点击立即选择地址
    $(document).off('click', '#select_addr').on('click', '#select_addr', function() {
        localStorage['select_address'] = JSON.stringify({"backurl":window.location.href});
        $.router.load("<{link ctl='ucenter/addr:index'}>", true);
    })

    // 点击添加地址
    $(document).off('click','#create_addr').on('click','#create_addr',function(){
        localStorage['select_address'] = JSON.stringify({"backurl":window.location.href});
    })
    // 立即购买

    var app_webview = "<{$app_webview}>";
    var android = "<{$android}>";

    function order_create() {
        $.ajax({
            url: "<{link ctl='weidian/pintuan:order_create'}>",
            async: true,
            dataType: 'json',
            data: $('#single_pintuan').serializeArray(),
            type: 'POST',
            success: function (ret) {
                if(ret.error == 0) {
                    // 下单成功
                    var order_id = parseInt(ret.order.order_id);
                    //如果是安卓，返回order_id给安卓
                    if(app_webview == 1 && android == 1){
                        window.Obj.return_order_id(ret.order.order_id,ret.order.amount,ret.order.dateline); //返回订单ID
                        return false;
                    }

                    var pay_status = parseInt(ret.order.pay_status);
                    var payment_link = "<{link ctl='weidian/ucenter/order:payment-"+order_id+"'}>";

                    if(ret.order.pay_status == 1) {
                        // 如果已支付直接跳转到订单详情页
                        Widget.MsgBox.success(ret.message);
                        setTimeout(function(){
                            Widget.MsgBox.hide();
                            window.location.href = "<{link ctl='weidian/pintuan:tuan_order_detail-"+order_id+"'}>";
                        },1000);
                    }else {
                        // 如果未支付跳转到支付页面
                        Widget.MsgBox.error(ret.message);
                        setTimeout(function(){
                            Widget.MsgBox.hide();
                            localStorage['payment_backurl'] = "<{link ctl='weidian/pintuan:tuan_order_detail-"+order_id+"'}>";
                            $.router.load(payment_link,true);
                        },1000)
                    }
                }else {
                    // 下单失败
                    Widget.MsgBox.error(ret.message);
                    setTimeout(function(){
                        Widget.MsgBox.hide();
                    },4000)
                }
            },
            error: function (xhr, status, err) {
                $.alert(err);
            },
        });
    }
</script>
<{include file="weidian/<{$theme_style}>/block/footer.html"}>