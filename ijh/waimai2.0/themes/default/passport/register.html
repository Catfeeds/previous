<{assign var='tpl_title' value=L("注册")}>
<{include file="block/header.html" }>
    <div class="page page-current">
        <!--头部-->
        <header class="bar bar-nav"> 
        	<a class="button button-link button-nav pull-left back"> 
        		<span class="iconfont icon-iconfontxiangyou"></span> 
        	</a> 
        	<a class="button button-link button-nav pull-right" href="<{link ctl='passport/login'}>">登录</a>
            <h1 class="title">注册</h1>
        </header>
        <!--头部结束-->
        <div class="content">
            <div class="login_tab_cont mt10">
                <div class="list_box">
                    <div class="list-block">
                        <ul>
                            <!-- Text inputs -->
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="iconfont icon-shouji"></i></div>
                                    <div class="item-inner">
                                        <div class="item-input">
                                            <input type="text" id="mobile" placeholder="手机号">
                                        </div>
                                        <a href="javascript:;" class="yzmget" id="yzmget2">获取验证码</a>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="iconfont icon-yanzhengma"></i></div>
                                    <div class="item-inner">
                                        <div class="item-input">
                                            <input type="text"  id="yzm" placeholder="验证码">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="iconfont icon-mima"></i></div>
                                    <div class="item-inner">
                                        <div class="item-input">
                                            <input type="password" id="passwd" placeholder="密码">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="iconfont icon-mima"></i></div>
                                    <div class="item-inner">
                                        <div class="item-input">
                                            <input type="password" id="repasswd" placeholder="确认密码">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="mt10">
                                <div class="item-content">
                                    <div class="item-media"><i class="iconfont icon-shuruyaoqingma"></i></div>
                                    <div class="item-inner">
                                        <div class="item-input">
                                            <input type="text" id="yaoqing" placeholder="请输入邀请码（可选）">
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="txt_center font_size14 mt10">输入邀请码可获得<span class="pointcl1">10</span>元红包</div>
                    <div class="content-block"> <a class="button button-big button-fill button-success" id="reg">注册</a> </div>
                    <div class="black9 regist_protocol"><label><span class="checkbox_xy"><input type="checkbox" id="checkbox_xy"></span>我已阅读并接受</label><a href="<{link ctl='passport/protocol'}>" class="maincl"><<{$register.title}>></a></div>
                </div>
            </div>            
        </div>        
    <!--内容结束-->   
    </div>
<script>
$(document).ready(function() {
    $(".checkbox_xy").click(function(){
		if($(this).hasClass("on")){
			$(this).removeClass("on");
		}else{
			$(this).addClass("on");
		}
	});
});

var mobile_timeout2;
var mobile_count2 = 1;
var mobile_lock2 = 0;

$(document).off('click','#yzmget2').on('click','#yzmget2',function(){
    if(!$("#yzmget2").hasClass("graybg")) {
        if($("#mobile").val()){
            if (mobile_lock2 == 0) {
                mobile_count2 = 60;
                $("#yzmget2").addClass("graybg");
                $('#yzmget2').attr("disabled", "disabled");
                verify_pic();
            }   
        }else{
            $.alert("请填写手机号");
        }
    }
    $("#yzmget2").removeClass("graybg");
})

BtnCount2 = function () {
    if (mobile_count2 == 0) {
		$("#yzmget2").removeClass("graybg");
        $('#yzmget2').removeAttr("disabled");
        $('#yzmget2').text("重新获取");
        mobile_lock2 = 0;
        clearTimeout(mobile_timeout2);
		$('#yzmget2').removeClass("on");
    }else if(mobile_count2 == 1) {
        $("#yzmget2").removeClass("graybg");
        $('#yzmget2').removeAttr("disabled");
        $('#yzmget2').text("获取验证码");
        mobile_lock2 = 0;
        clearTimeout(mobile_timeout2);
        $('#yzmget2').removeClass("on");
    }else {
        mobile_count2--;
        $('#yzmget2').text( + mobile_count2.toString() + "重新获取");
        mobile_timeout2 = setTimeout(BtnCount2, 1000);
		$('#yzmget2').addClass("on");
    }
};
		//注册页获取验证码部分结束

function verify_pic(){
	var modal = $.modal({
	    title: "<div class='txt_left'>请填写图形验证码</div>",
	    afterText:  "<div class='yzmint'><input type='text' id='pass-verify' value=''><span class='yzmimg'><img verify='#pass-verify' src="+"<{link ctl='magic:verify' http='ajax'}>&_=<{$pager.dateline}>"+" id='pass-verify'/></span></div>",
	    buttons: [
			{
				text: '取消'
			},
	      	{
	        	text: '确定',
	        	bold: true,
	        	onClick: function () {
                    var verifycode = $("#pass-verify").val();
                    var mobile = $("#mobile").val();
	        		var link = "<{link ctl='passport/verify_img'}>";
	                 $.post(link,{verifycode:verifycode,mobile:mobile},function(ret){
	                	 if(ret.error){
	                        	$.alert(ret.message);
	                        }else{
	                        	send_sms();
	                        }
	               },'json');
		        }
	      	},
		]
  	})
}

function send_sms(){
	var mobile = $('#mobile').val(); 
	var link = "<{link ctl='passport/sendsms'}>";
	$.post(link,{mobile:mobile},function(ret){
		if(ret.error == 0){
	    	BtnCount2();
			mobile_lock2 = 1;
			$(".get_yzm").addClass("on");
			$('.get_yzm').attr("disabled", "disabled");  
	    }else{
			$.alert(ret.message);
			mobile_lock2 = 0;
	    }
	},'json');
}

$(document).off('click','#reg').on('click','#reg',function(){
    var url_location = '<{link ctl='ucenter'}>';
    if(localStorage['url_login']){
        url_location = localStorage['url_login'];
    }
    if ($('#checkbox_xy').attr('checked')) {
        var mobile = $('#mobile').val(); 
        var yzm = $('#yzm').val();
        var yzm_val = $('#verifycode').val();
        var passwd = $('#passwd').val();
        var repasswd = $('#repasswd').val();
        var yaoqing = $('#yaoqing').val();
        var link = "<{link ctl='passport/register' }>";
        $.post(link,{mobile:mobile,yzm:yzm,yzm_val:yzm_val,passwd:passwd,repasswd:repasswd,yaoqing:yaoqing},function(ret){
            if(ret.error == 0){
                $.alert(ret.message);
                setTimeout(function(){
                   window.location.href=url_location;
                },2000)
                BtnCount2();
            }else{
                $.alert(ret.message);
                return ;
            }
            
        },'json');
    }else{
        $.alert("请阅读并接受《江湖外卖用户协议》");
        setTimeout(function(){$.closeModal();},3000);
    }
})

</script>
<{include file="block/footer.html"}>