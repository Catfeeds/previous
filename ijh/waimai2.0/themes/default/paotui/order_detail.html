<{assign var='tpl_title' value=L("订单详情")}>
<{include file="block/header.html" }>
<link rel="stylesheet" href="%THEME%/static/css/nouislider.min.css">
<script type='text/javascript' src='%THEME%/static/js/nouislider.js' charset='utf-8'></script>
    <div class="page page-current">
    	<!--头部-->
        <header class="bar bar-nav"> 
        	<a class="button button-link button-nav pull-left" href="<{link ctl='paotui/order'}>"> 
        		<span class="iconfont icon-iconfontxiangyou"></span>
        	</a>
        	<{if $order['staff_id']}>
        	<div class="button button-link button-nav pull-right">
        		<a href="#" class="iconfont icon-callphone-copy whitecl create-actions"></a>
        	</div>
        	<{/if}>
        	<h1 class="title">订单详情</h1>
        </header>
        <!--头部结束-->
    	<!--工具栏-->
        <nav class="bar bar-tab runord_footer">
        <{if $order['order_status'] == '0'}>
            <a href="javascript:;" class="button button-cancel open-slider-modal cancel" order_id="<{$order.order_id}>" id="cancel">取消订单</a>
            <{if $order['pay_status'] == '0'}>
            	<a href="<{link ctl='ucenter/order/payment' arg0=$order.order_id}>" class="button button-warning">去支付</a>
            <{else}>
            	<a href="javascript:;" class="button button-warning popup_tip">追加小费</a>
            <{/if}>
        <{elseif $order['order_status'] == '1'}>
        	<span></span>
            <a href="javascript:;" class="button button-cancel open-slider-modal"><span class="black9">等待服务</span></a>
            <span></span>
        <{elseif $order['order_status'] == '3' || $order['order_status'] == '4'}>
        	<span></span>
            <a href="javascript:;" class="button button-warning confirm">确认完成</a>
            <span></span>
        <{elseif $order['order_status'] == '8'}>
        	<{if $order['comment_status'] == '0'}>
	        	<a href="javascript:;" class="button button-warning popup_tip">打赏</a>
	            <a href="<{link ctl='paotui/order_comment' arg0=$order['order_id']}>" class="button button-warning">去评价</a>
	        <{else}>
	        	<a href="<{link ctl='paotui/order_comment' arg0=$order['order_id']}>" class="button button-cancel open-slider-modal"><span class="black9">查看评价</span></a>
	        <{/if}>
	    <{elseif $order['order_status'] == '-1'}>
        	<span></span>
            <a href="javascript:;" class="button button-warning repai">重新派活</a>
            <span></span>
        <{/if}>
        </nav>
        <!--工具栏结束-->
        <div class="content">
            <div class="ord_state">
            	<div class="state_box">
                	<h3 class="maincl"><{$order.order_status_label}><small class="black9">-<{$order.past_time}>下单</small></h3>
                    <p class="black9"><{$order.order_status_warning}></p>
                </div>
            </div>
            <!--订单详情-->
            <div class="runordDelt_box">
                <div class="list-block">
                    <ul>
                      <li class="item-content">
                        <div class="item-inner">
                        	<p class="black3">
                        	<{if $order['paotui_order'].type == 'buy'}>
                        		<span class="tag" style="background:#fb6624;">买</span>帮我买
                        	<{elseif $order['paotui_order'].type == 'song'}>
                        		<span class="tag" style="background:#2fd2a0;">送</span>帮我送
                        	<{else}>
                        		<span class="tag" style="background:#fab42e;">他</span><{$cate['title']}>
                        	<{/if}>
                        	</p>
                            <div class="item-after"><small class="black9">订单号：<{$order['order_id']}></small></div>
                        </div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black3">费用：<span class="fontcl1">￥<{$order.paotui_order.paotui_amount}>
                        <{if $order.paotui_order.reward_amount}>+<{$order.paotui_order.reward_amount + $tip_amount}>
                        元小费<{/if}><{if $ward_amount>0}>+<{$ward_amount}>元打赏<{/if}>
                        </span><{if $order.hongbao>0}>-<{$order.hongbao}>元红包<{/if}></p></div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">服务时间：</span><{$order.pei_time|format}></p></div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">备注：</span><{$order.intro}></p></div>
                      </li>
                      <li class="runSub_box">
                      	<div class="operate_nr">
                            <!-- <div class="box">
                                <div class="voice_box fl"><i class="ico"></i>5"</div>
                            </div>     -->                        
                            <div class="img_box">
                            <{foreach $order['paotui_order'].photo as $photo}>
                                <img src="<{$pager.img}>/<{$photo}>" class="list_img">
                            <{/foreach}>
                            </div>
                        </div>
                      </li>
                    </ul>
                </div>
            </div>
            
            <div class="runordDelt_box">
                <div class="list-block">
                    <ul>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">派活人：</span><{$order.contact}></p></div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">联系电话：</span><{$order.mobile}></p></div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">服务地址：</span><{$order.addr}><{$order.house}></p></div>
                      </li>
                    </ul>
                </div>
            </div>
            <{if $order['staff_id']}>
            <div class="runordDelt_box">
                <div class="list-block">
                    <ul>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">接单员：</span><{$staff.account_name}></p></div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner"><p class="black6"><span class="black3">联系电话：</span><{$staff.mobile}></p></div>
                      </li>
                    </ul>
                </div>
            </div>
            <{/if}>
            <!--订单详情结束-->
        </div>        
    <!--内容结束-->   
    </div>
<!--加小费弹出层-->
<div class="popup popup_tip_mask">
	<div class="tit">
		<a href="javascript:;" class="fl close-popup">取消</a> 
		<a href="javascript:;" class="fr close-popup add_tip" tip=''>确定</a>
	</div>
    <div class="tip_bar_box">
    	<div class="tipBar_w" id="slider-connect">
    		<span class="tip_num" id="tip_amount">0</span>
    	</div>
    </div>
    <div class="mineBalance_rechrg">
        <div class="list-block media-list">
          <ul>
            <li>
              <label class="label-checkbox item-content payment">
                <div class="item-inner"><img src="%THEME%/static/images/pay/pay1.png">支付宝</div>
                <input type="radio" name="way" checked="checked" paycode="alipay">
                <div class="item-media"><i class="icon icon-form-checkbox"></i></div>
              </label>
            </li>
            <{if $weixin==1}>
            <li>
              <label class="label-checkbox item-content payment">
                <div class="item-inner"><img src="%THEME%/static/images/pay/pay2.png">微信支付</div>
                <input type="radio" name="way" paycode="wxpay">
                <div class="item-media"><i class="icon icon-form-checkbox"></i></div>
              </label>
            </li>
            <{/if}>
            <li>
              <label class="label-checkbox item-content payment">
                <div class="item-inner"><img src="%THEME%/static/images/pay/pay3.png">余额支付</div>
                <input type="radio" name="way" paycode="money">
                <div class="item-media"><i class="icon icon-form-checkbox"></i></div>
              </label>
            </li>
          </ul>
        </div>
    </div>
</div>

<script>
$(document).off('click','.popup_tip').on('click','.popup_tip',function(){
  $.popup('.popup_tip_mask');
});

var connectSlider = document.getElementById('slider-connect');
//var s_start = "<{$order['paotui_order'].reward_amount}>";
var s_start = 0;

noUiSlider.create(connectSlider, {
	start: s_start,
	connect: 'lower',
	range: {
	  'min': 0,
	  'max': 100
	}
});

connectSlider.noUiSlider.on('update', function( values, handle ) {
	var tip = Math.round(values/100*50)+0;
	var amount = <{$config.buy_price}> + tip;
	$('.tip_num').html(tip);
	$('.add_tip').attr('tip',tip);
});

$('.create-actions').click(function(){
    var buttons1 = [
      {
        text: "<p class='mineAcntinfor_btn black3'><a href='tel:<{$staff.mobile}>'>联系骑手</a></p>",
        onClick: function() {
            window.open('tel:<{$staff.mobile}>');
        }
      },
    ];
    var buttons2 = [
      {
        text: "<div class='mineAcntinfor_btn black9'>取消</div>",
      }
    ];
    var groups = [buttons1, buttons2];
    $.actions(groups);
});


//取消理由样式
$(document).on('click','.mallord_delt_mask .selct_box a',function () {
    $(".mallord_delt_mask .selct_box a").removeClass("active");
    $(this).addClass("active");
});

// 检查补充说明字数
function checkLen(obj) {
    var len = GetStrLen($(obj).val());
    if(len <= 120) {
        var limit = 120-len;
        $('.txt_right').text('还可输入' + limit + '字');
    }
}

// 取消订单
function cancelanorder(reason_mark,order_id) {
    $.ajax({
        url: "<{link ctl='paotui:order_cancel'}>",
        async: true,
        dataType: 'json',
        data: {"order_id":order_id,"reason":reason_mark},
        type: 'POST',
        success: function (ret) {
            $.alert(ret.message);
            if(ret.error == 0 ) {
                setTimeout(function(){window.location.reload();},2000);
            }else {
                return false;
            }
        },
        error: function (xhr, status, err) {
            $.alert(err);
        },
    });
}

// 取消订单modal
$(document).off('click', '#cancel').on('click','#cancel', function () {
    var order_id = parseInt($(this).attr('order_id'));
    var c_html = '';
    c_html += '<div class="mallord_delt_mask"><div class="row selct_box" id="reason_mark">';
    <{foreach $reason as $v}>
    c_html += '<a href="javascript:;" class="fl col-33">'+'<{$v}>'+'</a>';
    <{/foreach}>
    c_html += '<div class="cl"></div></div><div class="list-block"><div class="item-input"><textarea maxlength="120" id="buchong" placeholder="补充说明" onkeyup="checkLen(this)" ></textarea><p class="txt_right font_size14 black9">还可输入120字</p></div></div></div>';

    var modal = $.modal({
        title: "<div class='mallord_delt_mask_tit'>取消理由</div>",
        afterText:c_html,
        buttons: [
            {
                text: "<span class='black6'>取消</span>"
            },
            {
                text: "<span class='maincl'>确定</span>",
                bold: true,
                onClick: function () {
                    var reason_mark = '';
                    if($('#reason_mark .active').text() == null) {
                        reason_mark = '取消理由:无';
                    }else {
                        reason_mark = '取消理由:' + $('#reason_mark .active').text();
                    }
                    if($('#buchong').val() == '') {
                        reason_mark += ',补充说明:无';
                    }else {
                        reason_mark += ',补充说明:' + $('#buchong').val();
                    }
                    cancelanorder(reason_mark,order_id);
                }
            },
        ]
    })
});

// 追加小费支付
$(document).off('click','.add_tip').on('click','.add_tip',function(){
    var order_id = parseInt(<{$order.order_id}>);
    var paycode = $('.label-checkbox.payment').find(':checked').attr('paycode');
	var amount = parseInt($('#tip_amount').text());
    var link = "/trade/payment/addreward-"+order_id+"-"+paycode+"-"+amount+".html";
    window.location.href = link;
})

$('.confirm').click(function(){
	var link = "<{link ctl='paotui/order_confirm' arg0=$order['order_id']}>";
	$.confirm("您要确认订单完成吗?", function(ret){
        if(ret){
        	window.location.href=link;
        }
    });
})

$('.repai').click(function(){
	var order_id = "<{$order['order_id']}>";
	$.ajax({  
        url: "<{link ctl='paotui/order_repai'}>", 
        dataType: 'json',  
        data: {"order_id":order_id},
        type: 'POST',   
        success: function (ret) { 
            if(ret.error > 0){
            	$.alert(ret.message);
            }else{
            	//console.log(ret);
            	localStorage['addr'] = ret.addr;
				localStorage['lng'] = ret.lng;
				localStorage['lat'] = ret.lat;
				localStorage['mobile'] = ret.mobile;
				localStorage['contact'] = ret.contact;
				localStorage['house'] = ret.house;
				localStorage['o_addr'] = ret.o_addr;
				localStorage['o_lng'] = ret.o_lng;
				localStorage['o_lat'] = ret.o_lat;
				localStorage['o_mobile'] = ret.o_mobile;
				localStorage['o_contact'] = ret.o_contact;
				localStorage['o_house'] = ret.o_house;
				localStorage['intro'] = ret.intro;
				localStorage['picker-style'] = ret.style;
				localStorage['typepick'] = ret.typepick;
				$.router.load(ret.link, true);
            }
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(errorThrown); 
        },  
    });
})
</script>

<{include file="block/footer.html"}>