<!DOCTYPE html>
<html>
    <head>
        <title>支付订单</title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../css/reset.css"/>
        <link rel="stylesheet" type="text/css" href="../css/css_1.css"/>
        <script src="../js/appcan.js"></script>
        <script src="../js/appcan.control.js"></script>
        <script src="../js/application.js"></script>
        <script src="../js/application.init.js"></script>
    </head>  
<body>
    <header>
        <a onclick="baoapp.helper.goback()"><i class="icon-goback"></i></a>
        <div class="title">支付订单</div>
    </header>
    
	<div id="content">    
    <div id="seat" class="page-center-box">
        <div id="scroll" class="pay">
         <!--模板占位-->
        </div>
    </div>
    </div>
</body>
<!--自定义模板-->
<script type="text/template" id="tmpl_buy">
            <div class="order-content">
                <ul class="list">
                    <li>
                    	 <span class="left">商品名称</span>
                  		<span class="right">%title%</span>
                  		<div class="clear"></div>
                  
                    </li>
                    <li>
                        <span class="left">数量</span>
                        <div class="rush-num right">
                            <span class="l jq_jian" onclick="operate('d')">-</span>
                            <span class="m jq_num">%num%</span>
                            <span class="r jq_jia" onclick="operate('i')">+</span>
                        </div>
                        <input type="hidden" value="1"  id="hidden_num" name="num">
                        <div class="clear"></div>
                    </li>
                    <li>
                        <span class="left">可使用积分</span><span class="right">%integral%积分</span>
                        <div class="clear"></div>
                    </li>
                    <li>
                        <span class="left">单价</span>
                        <span class="right"><span class="rush-price">%price%</span>元</span>
                        <div class="clear"></div>
                    </li>
                </ul>
            </div>
            <div class="sure-pay-but">
                <p class="left">总金额：<span id="all_price">￥%totalprice%</span></p>
                <div class="sure-pay right"><input type="submit" class="aniu" value="确认支付" style="background:none;border:none;color:#FFFFFF;font-size:0.16rem;width:100%;" onclick='gopay();'></div>
            </div>
</script>

<script>
//渲染视图
function renderHtml(data)
{
    with(document){
        var spanNode = createElement('span'),
            tmpl     = getElementById('tmpl_buy').innerHTML;
           
            for(key in data){
               regExp = new RegExp('%'+key+'%','g');
               tmpl = tmpl.replace(regExp, data[key]); 
            }
            spanNode.innerHTML = tmpl;
            querySelector('#scroll').appendChild(spanNode);
    }
}

function operate(type)
{
    if(type == 'i'){
        if(window['num']>=99)return false;
        ++window['num'];
    }else if(type == 'd'){
        if(window['num']<=1)return false;
        --window['num'];
    }
    window.totalPrice = (window['price']*window['num']).toFixed(2);
    $('.jq_num').text(window['num']);
    $('#all_price').text('￥'+window['totalPrice']);
}

function gopay()
{
    with(baoapp.helper){

        url = createUrl('tuan','order',{tuan_id:window.tuan_id,num:window.num});
        toast('订单创建中...',15000,null,1);
        ayscLoad(url,null,'GET','json',function(data){
            toast(null);
            if(data.status = CONST.BAO_REQUEST_SUCCESS){
                    toast('订单创建成功！',1000,function(){
                        param = '?num='+window.num+'&integral='+window.integral+'&addr='+escape(data['addr']);
                        param+= '&totalprice='+window.totalPrice+'&price='+window.price+'&order='+data['order'];
                        param+= '&gname='+escape(window['title'])+'&mf='+window.mobile_fan;
                        linkTo(KEY.TUAN_PAY,'pay.html'+param,null,5);
                    },1);
            }else{
                 toast(data.msg,1500,null,1);
            }
        });
    };
}

function goback()
{
    appcan.window.close(16,baoapp.config.close_duration);
    with(baoapp.helper){
        linkTo(KEY.TUAN_DETAIL,'detail.html?tuan_id='+window.tuan_id,null,5);
    };
}

</script>

<script>
appcan.ready(function(){
    var height = baoapp.helper.adapt();
    var search     = baoapp.helper.getRequest(location.search);
    var user_info  = appcan.locStorage.getVal(STORAGE.BAO_USER_INFO);
    var data = {title:unescape(search.title)};
    window.title  = search.title;
    window.tuan_id = search.tuan_id; 
    window.price   = data['price'] = search.price;
    window.totalPrice = data['totalprice'] = search.price;
    window.num     = data['num']   = 1;
    window.integral= data['integral'] = user_info.integral || 0;
    window.mobile_fan = search.mf;
    renderHtml(data);
});
</script>

</html>
