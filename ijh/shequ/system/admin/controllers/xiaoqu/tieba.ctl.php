<?php/** * Copy Right IJH.CC * Each engineer has a duty to keep the code elegant * $Id$ */if(!defined('__CORE_DIR')){    exit("Access Denied");}class Ctl_Xiaoqu_Tieba extends Ctl{    public function index($page = 1)    {        $filter = $pager = array();        $pager['page'] = max(intval($page), 1);        $pager['limit'] = $limit = 50;        if($SO = $this->GP('SO')){            $pager['SO'] = $SO;            if($SO['tieba_id']){                $filter['tieba_id'] = $SO['tieba_id'];            }            if($SO['city_id']){                $filter['city_id'] = $SO['city_id'];            }            if($SO['xiaoqu_id']){                $filter['xiaoqu_id'] = $SO['xiaoqu_id'];            }            if($SO['from']){                $filter['from'] = $SO['from'];            }            if($SO['title']){                $filter['title'] = "LIKE:%" . $SO['title'] . "%";            }            if($SO['content']){                $filter['content'] = "LIKE:%" . $SO['content'] . "%";            }            if($SO['contact']){                $filter['contact'] = "LIKE:%" . $SO['contact'] . "%";            }            if($SO['mobile']){                $filter['mobile'] = "LIKE:%" . $SO['mobile'] . "%";            }            if(is_array($SO['lasttime'])){                if($SO['lasttime'][0] && $SO['lasttime'][1]){                    $a = strtotime($SO['lasttime'][0]);                    $b = strtotime($SO['lasttime'][1]) + 86400;                    $filter['lasttime'] = $a . "~" . $b;                }            }            if(is_array($SO['dateline'])){                if($SO['dateline'][0] && $SO['dateline'][1]){                    $a = strtotime($SO['dateline'][0]);                    $b = strtotime($SO['dateline'][1]) + 86400;                    $filter['dateline'] = $a . "~" . $b;                }            }        }        $filter['closed'] = 0;        if($items = K::M('xiaoqu/tieba')->items($filter, null, $page, $limit, $count)){            $city_ids = $xiaoqu_ids = array();            foreach($items as $k => $v){                $city_ids[$v['city_id']] = $v['city_id'];                $xiaoqu_ids[$v['xiaoqu_id']] = $v['xiaoqu_id'];            }            $citys = K::M('data/city')->items_by_ids($city_ids);            foreach($items as $k => $v){                $items[$k]['city_name'] = $citys[$v['city_id']]['city_name'];            }            $xiaoqus = K::M('xiaoqu/xiaoqu')->items_by_ids($xiaoqu_ids);            foreach($items as $k => $v){                $items[$k]['xiaoqu_name'] = $xiaoqus[$v['xiaoqu_id']]['title'];            }            $pager['count'] = $count;                        $pager['pagebar'] = $this->mkpage($count, $limit, $page, $this->mklink(null, array('{page}')), array('SO' => $SO));        }                $this->pagedata['items'] = $items;        $this->pagedata['pager'] = $pager;        $this->tmpl = 'admin:xiaoqu/tieba/items.html';    }    public function so()    {        $this->tmpl = 'admin:xiaoqu/tieba/so.html';    }    public function detail($tieba_id = null, $page=1)    {        if(!$tieba_id = (int) $tieba_id){            $this->msgbox->add('未指定要查看内容的ID', 211);        }else if(!$detail = K::M('xiaoqu/tieba')->detail($tieba_id)){            $this->msgbox->add('您要查看的内容不存在或已经删除', 212);        }else{            $this->pagedata['detail'] = $detail;            $this->tmpl = 'admin:xiaoqu/tieba/detail.html';        }    }    public function create()    {        if($data = $this->checksubmit('data')){            if($tieba_id = K::M('xiaoqu/tieba')->create($data)){                $this->msgbox->add('添加内容成功');                $this->msgbox->set_data('forward', '?xiaoqu/tieba-index.html');            }        }else{            $this->tmpl = 'admin:xiaoqu/tieba/create.html';        }    }    public function edit($tieba_id = null)    {        if(!($tieba_id = (int) $tieba_id) && !($tieba_id = $this->GP('tieba_id'))){            $this->msgbox->add('未指定要修改的内容ID', 211);        }else if(!$detail = K::M('xiaoqu/tieba')->detail($tieba_id)){            $this->msgbox->add('您要修改的内容不存在或已经删除', 212);        }else if($data = $this->checksubmit('data')){            if(K::M('xiaoqu/tieba')->update($tieba_id, $data)){                $this->msgbox->add('修改内容成功');            }        }else{            $this->pagedata['detail'] = $detail;            $this->tmpl = 'admin:xiaoqu/tieba/edit.html';        }    }    public function doaudit($tieba_id = null)    {        if($tieba_id = (int) $tieba_id){            if(K::M('xiaoqu/tieba')->batch($tieba_id, array('audit' => 1))){                $this->msgbox->add('审核内容成功');            }        }        else if($ids = $this->GP('tieba_id')){            if(K::M('xiaoqu/tieba')->batch($ids, array('audit' => 1))){                $this->msgbox->add('批量审核内容成功');            }        }        else{            $this->msgbox->add('未指定要审核的内容', 401);        }    }    public function delete($tieba_id = null)    {        if($tieba_id = (int) $tieba_id){            if(!$detail = K::M('xiaoqu/tieba')->detail($tieba_id)){                $this->msgbox->add('你要删除的内容不存在或已经删除', 211);            }            else{                if(K::M('xiaoqu/tieba')->delete($tieba_id)){                    $this->msgbox->add('删除内容成功');                }            }        }        else if($ids = $this->GP('tieba_id')){            if(K::M('xiaoqu/tieba')->delete($ids)){                $this->msgbox->add('批量删除内容成功');            }        }        else{            $this->msgbox->add('未指定要删除的内容ID', 401);        }    }}