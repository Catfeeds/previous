<!DOCTYPE HTML>
<html>
    <head>
        <{include file="block/sheader.html"}>
        <script type="text/javascript" src="<{$pager.res}>/script/jquery.form.js"></script>
    </head>
    <body><div style='margin:0 auto;display:none;'>
        <img src='<{$pager.img}>/<{$CONFIG.site.logo}>' />
    </div>
        <form action="<{link ctl='order/comment_handle' }>" mini-form="car-form" id="comment_form" method="post">
            <header>
                <i class="left"><a href="" class="gobackIco"></a></i>
                <div class="title">
                    评价商家
                </div>
                <i class="right"><a class="searchIco" href="#"></a></i>
            </header>
            <section class="page_center_box">
                <script>
                    function fileSelected(obj, type) {
                        var files = obj.files;
                        for (var i = 0; i < files.length; i++) {
                            var tag = '';
                            var rFilter = /^(image\/gif|image\/jpeg|image\/jpg|image\/png)$/i;
                            if (!rFilter.test(files[i].type)) {
                                alert("只允许上传JPG、PNG、GIF格式图片");
                                return false;
                            }
                            var reader = new FileReader();
                            reader.onloadstart = function (e) {
                                $(".loading").show();
                            }
                            reader.onload = function (e) {
                                $('#photo' + type).hide();
                                $("#img" + type).attr("src", e.target.result).show();  //图片编码字符串
                            }
                            reader.readAsDataURL(files[i]);
                        }
                    }
                </script>
                <div class="shangjia mt10">
                    <div class="shangjia_attention mb10">
                        <div class="img fl"><img src="<{$pager.img}>/<{$shop.logo}>" width="100" height="100" /></div>
                        <div class="wz">
                            <div class="left">
                                <P><{$shop.title}></P>
                            </div>
                            <a href="javascript:void(0);" rel="<{$shop.collect}>" id="collect_btn" class="pub_btn"><{if $shop['collect'] ==0}>收藏<{else}>取消收藏<{/if}></a>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="nrBox mb10" style="border-top:0.01rem solid #dedede;">
                        <ul>
                            <li class="shangjia_hd_list score_fuwu"><p>服务质量&nbsp;&nbsp;<span class="starBg" style="position:relative;">

                                        <span class="star_clink"><a href="javascript:void(0);" val="1"></a><a href="javascript:void(0);" val="2"></a><a href="javascript:void(0);" val="3"></a><a href="javascript:void(0);" val="4"></a><a href="javascript:void(0);" val="5"></a>
                                        </span>
                                        <span class="star" style="width:60%;"></span>
                                        <input type='hidden' name="data[score_fuwu]" id="score_fuwu" value="3">
                                    </span></p>
                            </li>
                            <li class="shangjia_hd_list score_price"><p>服务价格&nbsp;&nbsp;<span class="starBg" style="position:relative;">

                                        <span class="star_clink"><a href="javascript:void(0);" val="1"></a><a href="javascript:void(0);" val="2"></a><a href="javascript:void(0);" val="3"></a><a href="javascript:void(0);" val="4"></a><a href="javascript:void(0);" val="5"></a>
                                        </span>

                                        <span class="star" style="width:60%;"></span>
                                        <input type='hidden' name="data[score_price]" id="score_price" value="3">
                                    </span></p>

                            </li>
                        </ul>
                        <div class="int_box_border" style="border-top:none 0;"><textarea name='data[content]' id="content" placeholder="说说您对本店的看法，长度在5-255字符之间"></textarea></div>
                    </div>
                    <div class="shangjia_imgUpload">
                        <ul>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo1" id="photo1" onchange="fileSelected(this, 1)" value="上传"   />
                                        <img src="" id="img1" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo2" id="photo2" onchange="fileSelected(this, 2)" value="上传"   />
                                        <img src="" id="img2" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo3" id="photo3" onchange="fileSelected(this, 3)" value="上传"   />
                                        <img src="" id="img3" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo4" id="photo4" onchange="fileSelected(this, 4)" value="上传"   />
                                        <img src="" id="img4" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="prompt">
                                    <p class="black9">112x112px</p>
                                    <p class="black9">限传4张图</p>
                                </div>
                            </li>
                        </ul>
                        <div class="clear"></div>
                    </div>
                    <input type='hidden' name='data[order_id]' id='order_id' value='<{$order.order_id}>'>
                </div>
            </section>
            <footer>
                <div class="ord_tousu">
                    <p class="fl">评价后可获得<span class="maincl"><{$jifen}></span>积分</p>
                    <input type="submit" value="提交评价" id="comment_submit" class="fr pub_btn coment" />
                </div>
            </footer>
        </form>    

        <script>
            $(document).ready(function () {
                $('.star_clink a').click(function () {
                    var val = $(this).attr('val');
                    $(this).parent().parent().find('input').val(val);
                    $(this).parent().parent().find('.star').css('width', val * 20 + '%');
                })


                
                $("#comment_form").ajaxForm({"target": "#comment_submit", "type": "post", "dataType": "json", "success": function (ret) {
                        if (ret.error == 0) {
                            layer.open({content: ret.message, time: 2});
                            setTimeout(function () {
                                window.location.href = "<{link ctl='order:orderwell'}>";
                            }, 2000);
                        } else {
                            layer.open({content: ret.message, time: 2});
                            return false;
                        }

                    }});
                
                $("#collect_btn").click(function(){
                    if($(this).attr('rel') == 1){
                        var url = "<{link ctl='shop/cancel' arg0=$order.shop_id}>";
                    }else{
                        var url = "<{link ctl='shop/collect' arg0=$order.shop_id}>";
                    }
                    $.post(url,{},function(data){
                        if(data.error >0){
                            layer.open({content:data.message,time:2});
                        }else{
                            layer.open({content:data.message,time:2});
                            setTimeout(function(){
                                window.location.reload(true);
                            },1000)
                        }
                    },'json')
                })

                if(localStorage['order_comment']) {
                    $(".gobackIco").attr("href", localStorage['order_comment']);
                }
            });
        </script>
    </body>
</html>